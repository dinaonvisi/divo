//-----------Tap_function
!function(a,b){"use strict";if("function"!=typeof a.createEvent)return!1;var c,d,e,f,g,h,i,j="undefined"!=typeof jQuery,k=!!navigator.pointerEnabled||navigator.msPointerEnabled,l=!!("ontouchstart"in b)&&navigator.userAgent.indexOf("PhantomJS")<0||k,m=function(a){var b=a.toLowerCase(),c="MS"+a;return navigator.msPointerEnabled?c:b},n={touchstart:m("PointerDown")+" touchstart",touchend:m("PointerUp")+" touchend",touchmove:m("PointerMove")+" touchmove"},o=function(a,b,c){for(var d=b.split(" "),e=d.length;e--;)a.addEventListener(d[e],c,!1)},p=function(a){return a.targetTouches?a.targetTouches[0]:a},q=function(){return(new Date).getTime()},r=function(b,e,f,g){var h=a.createEvent("Event");if(h.originalEvent=f,g=g||{},g.x=c,g.y=d,g.distance=g.distance,j&&(h=$.Event(e,{originalEvent:f}),jQuery(b).trigger(h,g)),h.initEvent){for(var i in g)h[i]=g[i];h.initEvent(e,!0,!0),b.dispatchEvent(h)}b["on"+e]&&b["on"+e](h)},s=function(a){var b=p(a);e=c=b.pageX,f=d=b.pageY,h=q(),A++},t=function(a){var b=[],j=f-d,k=e-c;if(clearTimeout(g),-v>=k&&b.push("swiperight"),k>=v&&b.push("swipeleft"),-v>=j&&b.push("swipedown"),j>=v&&b.push("swipeup"),b.length)for(var l=0;l<b.length;l++){var m=b[l];r(a.target,m,a,{distance:{x:Math.abs(k),y:Math.abs(j)}})}else h+w-q()>=0&&e>=c-y&&c+y>=e&&f>=d-y&&d+y>=f&&(r(a.target,2===A&&i===a.target?"dbltap":"tap",a),i=a.target),g=setTimeout(function(){A=0},x)},u=function(a){var b=p(a);c=b.pageX,d=b.pageY},v=b.SWIPE_THRESHOLD||100,w=b.TAP_THRESHOLD||150,x=b.DBL_TAP_THRESHOLD||200,y=b.TAP_PRECISION/2||30,z=b.JUST_ON_TOUCH_DEVICES||l,A=0;o(a,n.touchstart+(z?"":" mousedown"),s),o(a,n.touchend+(z?"":" mouseup"),t),o(a,n.touchmove+(z?"":" mousemove"),u)}(document,window);

//-----------Tap_function

shop2.queue.addToCart = function() {
    
    $(document).on('click', '.shop-product-btn', function(e) {

        var $this = $(this),
            $form = $this.closest('form'),
            form = $form.get(0),
            adds = $form.find('.additional-cart-params'),
            len = adds.length,
            i, el,
            a4 = form.amount.value,
            kind_id = form.kind_id.value;
            
            
        e.preventDefault();

        if (len) {
            a4 = {
                amount: a4
            };

            for (i = 0; i < len; i += 1) {
                el = adds[i];
                if (el.value) {
                    a4[el.name] = el.value;
                }
            }
        }

        shop2.cart.add(kind_id, a4, function(d) {

            $('#shop2-cart-preview').replaceWith(d.data);

            if (d.errstr) {
                shop2.msg(d.errstr, $this);
            } else {
                shop2.msg(window._s3Lang.JS_ADDED, $this);
            }

            if (d.panel) {
                $('#shop2-panel').replaceWith(d.panel);
            }
        });

    });

}
shop2.queue.cart = function() {

    var updateBtn = $('.shop2-cart-update'),
        cartTable = $('.shop2-cart-wrapper'),
        form = $('#shop2-cart');

    shop2.on('afterCartRemoveItem, afterCartUpdate', function() {
        document.location.reload();
    });

    function updateBtnShow() {
        updateBtn.show();
    }

    cartTable.find('input:text').on('keypress', function(e) {
        if (e.keyCode == 13) {
            shop2.cart.update(form);
        } else {
            updateBtnShow();
        }
    });

    cartTable.find('.amount-minus, .amount-plus').on('click', updateBtnShow);

    updateBtn.on('click', function(e) {
        e.preventDefault();
        shop2.cart.update(form);
        return false;
    });


    $('.cart-delete a').on('click', function(e) {
        var $this = $(this),
            id = $this.data('id');

        e.preventDefault();

        shop2.cart.remove(id);

    });

}
shop2.queue.filter = function() {

    var wrap = $('.shop2-filter'),
        result = $('.result');

    shop2.filter.init();

    shop2.on('afterGetSearchMatches', function (d, status) {

        if (d.data.total_found === 0) {

            result.addClass('no-result');
        } else {
            result.removeClass('no-result');
        }

        $('#filter-result').html(d.data.total_found);

        result.removeClass('hide');
    });

    wrap.find('.param-val').on('click', function(e) {
        var $this = $(this),
            name = $this.data('name'),
            value = $this.data('value');

        e.preventDefault();

        $this.toggleClass('active-val');
        shop2.filter.toggle(name, value);
        shop2.filter.count();
    });

    wrap.find('select').on('change', function() {
        var $this = $(this),
            name = this.name,
            value = $this.val();

        shop2.filter.add(name, value);
        shop2.filter.count();
    });

    wrap.find('input:text').keyup(function() {
        var $this = $(this),
            name = $this.attr('name');

        $.s3throttle('filter: ' + name, function() {
            var value = $this.val();

            shop2.filter.add(name, value);
            shop2.filter.count();
        }, 500);
    });
    wrap.find('.input_range_slider').on('slide', function(e){
        var $this = $(this),
            $parent = $this.closest('.range_slider_wrapper'),
            $input = $parent.find('input:text');
            
        $.each($input, function(i, elem) {
            var name = $(elem).attr('name');

            $.s3throttle('filter: ' + name, function() {
                var value = $(elem).val();
        
                shop2.filter.add(name, value);
                shop2.filter.count();
            }, 500);
        });
    });

    wrap.find('.shop-filter-go').on('click', function(e) {
        e.preventDefault();
        shop2.filter.go();
    });
}
shop2.filter.sort = function(name, elem) {
    var re = new RegExp(this.escape('s[sort_by]') + '=([^&]*)'),
        params = this.str.match(re),
        desc = name + ' desc',
        asc = name + ' asc',
        isDesc = (elem.is('.sort-param-desc'));


    params = (params && params.length > 1) ? params[1] : '';
    
    params = (isDesc) ? desc : asc;

    this.remove('s[sort_by]');
    this.add('s[sort_by]', params);
    return this;
}
shop2.queue.sort = function() {
    var wrap = $('.sorting');

    wrap.find('.sort-param').on('click', function(e) {
        var $this = $(this),
            name = $this.data('name');

        e.preventDefault();
        shop2.filter.sort(name, $this);
        shop2.filter.go();
    });

    wrap.find('.sort-reset').on('click', function(e) {
        e.preventDefault();
        shop2.filter.remove('s[sort_by]');
        shop2.filter.go();
    });
}
shop2.queue.delivery = function() {

    var options = $('.option-label'),
        groups = $('.option-type'),
        details = options.next();

    options.on('click', function() {
        var $this = $(this),
            index = $this.parent().index();

        groups.removeClass('active-type').eq(index).addClass('active-type');
        details.find('input, textarea, select').prop('disabled', true);
        $this.next().find('input, textarea, select').prop('disabled', false);

        $this.next().find('select').styler({
        	selectPlaceholder: 'Все',
        	onSelectClosed: function() {
        		$this.next().find('select').trigger('refresh');
        	}
        });

    });

    $('#shop2-ems-calc, #shop2-edost-calc').on('click', function(e) {
        var $this = $(this),
            attach_id = $this.data('attach-id'),
            to = $('select[name=' + attach_id + '\\[to\\]]'),
            zip = $('input[name=' + attach_id + '\\[zip\\]]');

        if (to.length == 0) {
            to = $('#shop2-edost2-to');
        }

        e.preventDefault();

        to = to.get(0)? to.val() : '';
        zip = zip.get(0)? zip.val() : '';

        shop2.delivery.calc(attach_id, 'to=' + to + '&zip=' + zip, function(d) {
            if (!d.data && d.errstr) {
                shop2.alert(d.errstr);
                $('#delivery-' + attach_id + '-cost').html(0);
            } else {
                $('#delivery-' + attach_id + '-cost').html(d.data.cost);

                if (d.data.html) {
                    $('#delivery-' + attach_id + '-html').html(d.data.html);
                    shop2.queue.edost();
                }
            }

        });

    });
}
shop2.queue.product = function() {

    shop2.product._reload = function(node) {

        var $node = $(node);
        var kinds = shop2.product.getNodeData(node, 'kinds', true);
        var paramName = shop2.product.getNodeData(node, 'name');
        var paramValue = shop2.product.getNodeData(node, 'value');
        var $form = $node.closest('form');
        var form = $form.get(0);
        var meta;
        var kind_id;
        var product_id;
        var keys = {};

        if (kinds && $.type(paramName) !== 'undefined' && $.type(paramValue) !== 'undefined' && form) {

            meta = $form.find('input[name=meta]').val();

            product_id = $form.find('input[name=product_id]').val();

            $form.find('[name=submit]').prop('disabled', true);

            $form.find('select.shop2-cf>option, li.shop2-cf, li.shop2-color-ext-selected, ul.shop2-color-ext-list>li').each(function() {
                var name = $(this).data('name');
                if (name) {
                    keys[name] = true;
                }
            });

            kind_id = shop2.product.findKindId(product_id, kinds, paramName, paramValue, meta, keys);

            if (shop2.mode == 'product') {

                if (shop2.uri) {
                    document.location = shop2.uri + '/product/' + kind_id;
                } else {
                    document.location = document.location.href.replace(/\/product\/.+/, '/product/' + kind_id);
                }

            } else {

                shop2.product.getProductListItem(product_id, kind_id, function(d, status) {
                    var cont, newCont, body;
                    if (status === 'success') {

                        cont = $node.closest('.shop2-item-product');
                        cont.hide();

                        body = $.trim(d.data.body);
                        newCont = $(body).insertBefore(cont);

                        cont.remove();

                        shop2.queue.heights();
                    }

                });

            }
        }

    };

    $.on('select.shop2-cf', {
        change: function() {
            shop2.product._reload(this);
        }
    });

    $.on('li.shop2-cf:not(.active-color, .active-texture)', {
        click: function() {
            shop2.product._reload(this);
        }
    });

}
shop2.msg = function(text, obj) {
    var selector = '#shop2-msg',
        msg = $(selector),
        offset = obj.offset(),
        width = obj.outerWidth(true),
        height = obj.outerHeight();

    if (!msg.get(0)) {
        msg = $('<div id="shop2-msg">');
        $(document.body).append(msg);
        msg = $(selector);
    }

    msg.html(text).show();

    var msgWidth = msg.outerWidth();
    var left = offset.left + width;
    var top = offset.top + height;

    if (left + msgWidth > $(window).width()) {
        left = offset.left;
    }

    msg.css({
        left: left,
        top: top
    });

    $.s3throttle('msg', function() {
        msg.hide();
    }, shop2.options.msgTime);

}
shop2.queue.discounts = function() {
    var clickStart = (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) ? 'tap' : 'click.respons';
    
    $(document).on(clickStart, '.shop2-product-actions dt', function(e) {
        var $this = $(this),
            win = $this.next(),
            left = $this.position().left,
            maxWidth = $(window).width() - $this.offset().left - 40;
            

        e.stopPropagation();

        if (win.is(':hidden')) {
            $('.shop2-product-actions dd').hide();
            win.show();
            win.css('left', left);
            win.css('maxWidth', maxWidth);
        } else {
            win.hide();
        }

    });

    $(document).on(clickStart, '.close-desc-action', function(e) {
        var $this = $(this),
            win = $this.closest('dd');

        e.stopPropagation();

        win.hide();
    });

    $(document).on(clickStart, function() {
        $('.shop2-product-actions dd').hide();
    });

}
shop2.queue.question = function() {
    var cls = '.price-old.question, .shop-cart-total .question';
    
    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || /[\?&]panel_fake_mobile=1(&|$)/.test(document.location.search)){
        $('.price-old.question, .shop-cart-total .question').on('click', function(event) {
            var $this = $(this),
                win = $this.next().show(),
                position = $this.position(),
                height = win.outerHeight(true),
                maxWidth = $(window).width() - $this.offset().left - 30;
            
            if (!$this.next().hasClass('classThis')) {
                $this.next().addClass('classThis');
                win.css({
                    top: position.top - height - 5,
                    left: position.left,
                    maxWidth: maxWidth
                });
            } else {
                var $this = $(this),
                    win = $this.next();
                    
                $this.next().removeClass('classThis');
                
                win.hide();
            }
        });
    } else {
        $(document).on('mouseenter', cls, function() {
            var $this = $(this),
                win = $this.next().show(),
                position = $this.position(),
                height = win.outerHeight(true),
                maxWidth = $(window).width() - $this.offset().left - 30;
    
            win.css({
                top: position.top - height - 5,
                left: position.left,
                maxWidth: maxWidth
            });
    
        }).on('mouseleave', cls, function() {
    
            var $this = $(this),
                win = $this.next();
    
            win.hide();
    
        });
    }

}
$(function() {
    $('table').wrap('<div class="table-wrapper"></div>');

    //bind image load

    $.fn.bindImageLoad = function (callback) {
      function isImageLoaded(img) {
          if (!img.complete) {
              return false;
          }
          if (typeof img.naturalWidth !== "undefined" && img.naturalWidth === 0) {
              return false;
          }
          return true;
      }

      return this.each(function () {
          var ele = $(this);
          if (ele.is("img") && $.isFunction(callback)) {
              ele.one("load", callback);
              if (isImageLoaded(this)) {
                  ele.trigger("load");
              }
          }
      });
    };
    
    var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || /[\?&]panel_fake_mobile=1(&|$)/.test(document.location.search),
        isApple = /iPod|iPad|iPhone/i.test(navigator.userAgent),
        clickStart = (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) ? 'tap' : 'click.respons';

    //----Paginattion
    
    (function(){
        var str = document.location.href;
        var docOrigin = document.location.origin;
        var docPathname = document.location.pathname;
        var docSearch = document.location.search;
        var inVal = null;
        var maxInpValue = parseInt($('.shop2-pagelist li.active-select input').attr('max'));
        var minInpValue = parseInt($('.shop2-pagelist li.active-select input').attr('min'));
        
        
		$('.shop2-pagelist li.active-select input').on('keyup change', function() {
			$(this).addClass('active');
		});
		
        $('.shop2-pagelist li.active-select form').submit(function() {

        	inVal = Number($('.shop2-pagelist li.active-select input').val().replace(/.*?(-?\d+).*/, '$1') - 1);
            inValTwo = $('.shop2-pagelist li.active-select input').val().replace(/.*?(-?\d+).*/, '$1');

            if (inValTwo > maxInpValue) {
                inVal = maxInpValue - 1;
            }
            if (inValTwo < minInpValue) {
                inVal = minInpValue - 1;
            }
        	
            if (shop2.mode == 'search') {
            	if(str.match(/p\=\d+/)) {
            		document.location.href = str.replace(/search\?p=\d+/,'search?p=' + inVal);
            	} else {
            		document.location.href = str.replace('search?','search?p=' + inVal + '&');
            	}
            }
            
            if (shop2.mode == 'folder') {
            	if(str.match(/p\/\d+/)) {
            		document.location.href = str.replace(/p\/\d+/, 'p' + '/' + inVal);
        		} else {
        			document.location.href = docPathname.replace(/\/?$/, '/p/' + inVal);
        		}
            }

            return false;
        });
    })();
    
   
    
    //----Product-main-slider
    var $owlMainSlider = $('.slider-main-in');
    function owlControls() {
        var owlControlsWr = $('<div class="main-owl-controls"/>');
            owlControlsWr.appendTo('.slider-main-in');

        $('.slider-main-in').find('.owl-nav, .owl-dots').appendTo('.main-owl-controls');
    }
    $owlMainSlider.owlCarousel ({
        margin: 0,
        loop: 1,
        autoplay: 1,
        dots: 1,
        nav: 1,
        responsive: {
          0: {
            items: 1
          }
        },
        onInitialized : function() {
            owlControls()
        }
    });

    //---Main-folder-block
    function mainFolderNav() {
            $('.main-folder-block-in').find('.owl-nav').appendTo('.main-folder-title');
    }

    var $owlMainFolder = $('.main-folder-block-in');

    $owlMainFolder.owlCarousel ({
        margin: 20,
        loop: 0,
        autoplay: 0,
        dots: 0,
        nav: 1,
        responsive: {
          0: {
            items: 3
          }
        },
        onInitialized : function() {
            mainFolderNav()
        }
    });

    //---Main-new-block
    function mainNewNav() {
        $('.shop-main-block').each(function() {
            var $this = $(this);
            var owlControlsWr = $('<div class="main-owl-controls"/>');

            owlControlsWr.appendTo($this.find('.product-list-main'));
            $this.find('.owl-dots').appendTo($this.find('.main-owl-controls'));
            $this.find('.owl-nav').appendTo($this.find('.shop-main-block-title'));
            
        });
    }

    var $owlMainBlock = $('.product-list-main'),
        owlItemLength = $('.product-list-main .shop2-item-product').length;

    $owlMainBlock.each(function() {
    	var $this = $(this);
    	$this.owlCarousel ({
	        margin: 20,
	        loop: owlItemLength > 4 ? 1 : 0,
	        autoplay: 0,
	        dots: 1,
	        nav: 1,
	        responsive: {
	          0: {
	            items: 2
	          },
	          620: {
	            items: 3
	          },
	          820: {
	            items: 4
	          }
	        },
	        onInitialized : function() {
	        }
	    });
    });
    mainNewNav()

    //---Autorisation
    $('.block-user-title, .block-user-body-close, .block-user-btn-mobile').on('click', function(event) {
        event.preventDefault();
        $('.block-user').toggleClass('active');
    });

    //---Search
    $('.search-shop-opened-btn, .search-online-title').on('click', function(event) {
        event.preventDefault();
        $('.search-online-store').toggleClass('opened');
        $('.search-overlay-bg').toggleClass('active');
    });
    $('.search-close-btn, .search-block-btn').on('click', function(event) {
        event.preventDefault();
        $('.block-user, .search-overlay-bg').removeClass('active')
        $('.search-block-wr').toggleClass('active');
    });

    //---Top-menu
    var topMenuFlag = 1;
    
    function topMenu() {
        if ((!isMobile && window.matchMedia('(min-width:940px)').matches) && (topMenuFlag == 1 || topMenuFlag == 3)){

            $('.menu-top-wr').removeClass('topMenuMobile');
            $('.top-panel-wr').removeClass('topPanelMobile');
            $('.block-user').removeClass('blockUserMobile');
            $('.search-block-wr').removeClass('searchBlockMobile');

            $(function() {
                $('.menu-top-wr .menu-top').s3MenuAllIn({
                    type: 'bottom',
                    debug: 0,
                    activateTimeout: 250,
                    showTime: 250,
                    hideTime: 250,
                    showFn: $.fn.fadeIn,
                    hideFn: $.fn.fadeOut
                });
            });

            $(window).load(function() {
                $('.menu-top').oneLineMenu({
                    minWidth : 940
                });
            });

            $('.menu-top-wr .menu-top li').each(function(){     
                var $this = $(this);

                if ($this.find('> ul').get(0)) {
                    $this.find('> a > .s1').remove();
                    $this.find('> a').removeClass('hasMenu');
                }
            });

            topMenuFlag = 2;
        }else if((isMobile && (topMenuFlag == 1 || topMenuFlag == 2)) || window.matchMedia('(max-width:939px)').matches && (topMenuFlag == 1 || topMenuFlag == 2)){

            $('.menu-top-wr').addClass('topMenuMobile');
            $('.top-panel-wr').addClass('topPanelMobile');
            $('.block-user').addClass('blockUserMobile');
            $('.search-block-wr').addClass('searchBlockMobile');

            $('.menu-top-wr .menu-top').off('mouseenter mouseleave');
            $('.menu-top-wr .menu-top').find('.s3-menu-allin-has').removeClass('s3-menu-allin-has');
            $('.menu-top-wr .menu-top').find('ul').removeAttr('style');

            if (topMenuFlag == 1 || topMenuFlag == 2) {
                $('.menu-top-wr .menu-top li').each(function(){
                    var $this = $(this),
                    $spanS1 = $('<span class="s1"></span>');
                    
                    if ($this.find('> ul').get(0)) {
                        $this.find('> a').append($spanS1);
                        $this.find('> a').addClass('hasMenu')
                    }
                    if ($this.hasClass('opened')) {
                        $this.find($spanS1).addClass('active');
                    }
                });
                $('.menu-top-wr .menu-top li span.s1').on(clickStart, function() {
					var $this = $(this);
					var ul = $this.parents('li:first').find('ul:first');
					var $li = $this.closest('li');
					
					if (ul.get(0)) {
							ul.toggle();
							$this.toggleClass('active');
							$this.closest('a').toggleClass('active');

							$li.siblings().filter(':has(">ul")').each(function(){
								var $this = $(this);
								$this.find('>ul').css('display', 'none');
								$this.find('> a').removeClass('active');
							});
							return false;
					}
					return true;
                });
            }

            topMenuFlag = 3;
            
            $('.folder-block-wr .folder-ul li a').on('click', function(e) {
            	if ($(e.target).closest('.s1').length) return false;
            });
        }
    }
    $('.menu-top-btn, .menu-top-close').on('click', function(event) {
        event.preventDefault();
        
        $('.menu-top-wr').toggleClass('opened');
        if ($('.menu-top-wr').hasClass('opened') && isMobile){
            if (isApple) {
                $('html, body').addClass('overflowHidden');
            } else{
                $(document.documentElement).addClass('overflowHidden');
            }
        } else {
            if (isApple) {
                $('html, body').removeClass('overflowHidden');
            } else{
                $(document.documentElement).removeClass('overflowHidden');
            }
        }
    });

    //---Folder
    var folderBlockFlag = 1;

    function folderBlock() {
        if ((!isMobile && window.matchMedia('(min-width:940px)').matches) && (folderBlockFlag == 1 || folderBlockFlag == 3)){

            $('.folder-block-wr').removeClass('folderBlockMobile');
            $('.brand-block-wr').removeClass('brandBlockMobile');

            $(function() {
                $('.folder-block-wr .folder-ul').s3MenuAllIn({
                    type: 'right',
                    debug: 0,
                    activateTimeout: 0,
                    showTime: 250,
                    hideTime: 250,
                    showFn: $.fn.fadeIn,
                    hideFn: $.fn.fadeOut
                });
            });
            $('.folder-block-wr .folder-ul li').each(function(){        
                var $this = $(this);

                if ($this.find('> ul').get(0)) {
                    $this.find('> a > .s1').remove();
                    $this.find('> a').removeClass('hasMenu');
                }
            });

            folderBlockFlag = 2;
        }else if((isMobile && (folderBlockFlag == 1 || folderBlockFlag == 2)) || window.matchMedia('(max-width:939px)').matches && (folderBlockFlag == 1 || folderBlockFlag == 2)){
            $('.folder-block-wr').addClass('folderBlockMobile');
            $('.brand-block-wr').addClass('brandBlockMobile');

            $('.folder-block-wr .folder-ul').off('mouseenter mouseleave');
            $('.folder-block-wr .folder-ul').find('.s3-menu-allin-has').removeClass('s3-menu-allin-has');
            $('.folder-block-wr .folder-ul').find('ul').removeAttr('style');

            if (folderBlockFlag == 1 || folderBlockFlag == 2) {
                $('.folder-block-wr .folder-ul li').each(function(){
                    var $this = $(this),
                    $spanS1 = $('<span class="s1"></span>');
                    
                    if ($this.find('> ul').get(0)) {
                        $this.find('> a').append($spanS1);
                        $this.find('> a').addClass('hasMenu')
                    }
                    if ($this.hasClass('opened')) {
                        $this.find($spanS1).addClass('active');
                    }
                });
                $('.folder-block-wr .folder-ul li span.s1').on(clickStart, function(even) {
			        event.preventDefault();
					var $this = $(this);
					var ul = $this.parents('li:first').find('ul:first');
					var $li = $this.closest('li');
					
					setTimeout(function() {
						if (ul.get(0)) {
							ul.toggle();
							$this.toggleClass('active');
							$this.closest('a').toggleClass('active');
	
							$li.siblings().filter(':has(">ul")').each(function(){
								var $this = $(this);
								$this.find('>ul').css('display', 'none');
								$this.find('> a').removeClass('active');
							});
							return false;
						}
						return true;
					}, 50);
				
                });
            }

            folderBlockFlag = 3;
        }
    }

    $('.folder-block-title, .folder-block-close').on('click', function(event) {
        event.preventDefault();
        $('.brand-block-wr').removeClass('opened');
        $('.search-block-wr').removeClass('active')
        $('.folder-block-wr').toggleClass('opened');

        if ($('.folder-block-wr').hasClass('opened') && isMobile){
            $('.search-overlay-bg').addClass('active')
        } else {
            $('.search-overlay-bg').removeClass('active')
        }
    });

    //--Brand
    $('.brand-block-title, .brand-block-close').on('click', function(event) {
        event.preventDefault();
        $('.folder-block-wr').removeClass('opened');
        $('.search-block-wr').removeClass('active')
        $('.brand-block-wr').toggleClass('opened');
        if ($('.brand-block-wr').hasClass('opened') && isMobile){
            $('.search-overlay-bg').addClass('active')
        } else {
            $('.search-overlay-bg').removeClass('active')
        }
    });

    //Amount-minus-disabled

    $('.shop2-cart-product, .shop2-item-product, .product-r-side, .shop-kind-item').each(function(index) {
        var $this = $(this),
            $amountInput = $this.find('.shop2-product-amount input[type="text"]'),
            amountInputValue = $amountInput.val();

        function amounMinus() {
            if (amountInputValue >= 2) {
                $this.find('.shop2-product-amount button.amount-minus').removeClass('disabled');
            } else {
                $this.find('.shop2-product-amount button.amount-minus').addClass('disabled');
            }
        }
        amounMinus();

        $this.find('.shop2-product-amount button').on(clickStart, function(e) {
            setTimeout(function() {
                amountInputValue = $amountInput.val();

                amounMinus();
            }, 100);
        });
        $this.find('.shop2-product-amount input').on('keyup', function(e) {
            setTimeout(function() {
                amountInputValue = $amountInput.val();

                amounMinus();
            }, 100);
        });
    });
    //--Filter
    var $filterBtn = $('.shop2-filter-btn'),
        $filterWr = $('.shop2-filter');

    $filterBtn.on(clickStart, function(event) {
        event.preventDefault();
        
        $filterWr.toggleClass('opened');
    });

    //---Sorting
    var $sortingBtn = $('.sorting-wrap .sort-title'),
        $sortingBlock = $('.sorting-wrap .sorting-block'),
        sortingParamLink = $('.sorting-wrap .sort-param.active');

    $('.type-checkbox .param-val').on(clickStart, function(event) {
        $(this).closest('.type-checkbox').find('.param-val').not(this).removeClass('active-val')
    });

    $sortingBtn.on(clickStart, function(event) {
        $('.sorting-wrap').toggleClass('opened');
    });

    function sortingTitle() {
        var paramClone = sortingParamLink.first().clone().addClass('clone');

        $sortingBtn.html(paramClone);

        $('.shop-sorting-panel .sorting-wrap .sort-param.clone').on(clickStart, function(event) {
            event.preventDefault();
        });
    }
    if (sortingParamLink.hasClass('active')){
        sortingTitle();
    }
    //Views-shop-btn

    function viewBtnMobile() {
        if ($(window).width() <= 630) {
            var $viewBtnActive = $('.shop-sorting-panel .view-shop2 a.active-view');

            $viewBtnActive.prependTo('.shop-sorting-panel .view-shop2');

            $(document).on(clickStart, function(event) {
                if ($(event.target).closest('.view-shop2').length) return;
                $('.view-shop2').removeClass('opened');

                $viewBtnActive = $('.shop-sorting-panel .view-shop2 a.active-view');
                $viewBtnActive.prependTo('.shop-sorting-panel .view-shop2');
            });
            $('.shop-sorting-panel .view-shop2 a').on(clickStart, function(event) {
                event.preventDefault();
                $('.view-shop2').addClass('opened');
            });
        }
    }
    //-----View-btn
    var $btnThumbs = $('.view-shop2 .thumbs'),
        $btnSimple = $('.view-shop2 .simple'),
        $btnPrice = $('.view-shop2 .pricelist'),
        $lotsWrap = $('.product-list');

        var temp = 1;
        $('.product-list-thumbs .product-image img').bindImageLoad(function(){
            temp++;
            if(temp == $('.product-list-thumbs .product-image img').length) {
                var heights = [],
                    maxHeight;
                    
                $('.shop2-item-product .product-image').css('height', 'auto');

                $('.shop2-item-product .product-image').each(function(){
                    heights.push($(this).height());
                });
                maxHeight = Math.max.apply(null, heights);
                
                $('.shop2-item-product .product-image').each(function(){                        
                    $(this).css('height', maxHeight);
                });
            }
        });
    function thumbsLots() {
        $btnThumbs.addClass('active-view');
        $btnSimple.removeClass('active-view');
        $btnPrice.removeClass('active-view');
        $lotsWrap.addClass('product-list-thumbs');
        $lotsWrap.removeClass('product-list-simple');
        $lotsWrap.removeClass('product-list-price');

        var temp = 1;
        
        setTimeout(function(){
            $('.product-list-thumbs .product-image img').bindImageLoad(function(){
                temp++;
                if(temp == $('.product-list-thumbs .product-image img').length) {
                    var heights = [],
                        maxHeight;
                        
                    $('.shop2-item-product .product-image').css('height', 'auto');

                    $('.shop2-item-product .product-image').each(function(){
                        heights.push($(this).height());
                    });
                    maxHeight = Math.max.apply(null, heights);
                    
                    $('.shop2-item-product .product-image').each(function(){                        
                        $(this).css('height', maxHeight);
                    });
                }
            });
        }, 300);
        if ($('.product-image-wr .product-info-top').length){
            $('.shop2-item-product').each(function() {
                var $prodImage = $(this).find('.product-info-wr');
                $(this).find('.product-info-top').prependTo($prodImage);
                $(this).find('.shop2-product-actions-wr').prependTo($(this).find('.product-bot-wr'));
            });
        }
    }
    function simpleLots() {
        $btnSimple.addClass('active-view');
        $btnThumbs.removeClass('active-view');
        $btnPrice.removeClass('active-view');
        $lotsWrap.addClass('product-list-simple');
        $lotsWrap.removeClass('product-list-thumbs');
        $lotsWrap.removeClass('product-list-price');

        $('.shop2-item-product .product-image').css('height', 'auto');

        if ($('.product-image-wr .product-info-top').length){
            $('.shop2-item-product').each(function() {
                var $prodImage = $(this).find('.product-info-wr');
                $(this).find('.product-info-top').prependTo($prodImage);
                $(this).find('.shop2-product-actions-wr').prependTo($(this).find('.product-bot-wr'));
            });
        }
    }
    function priceLots() {
        $btnPrice.addClass('active-view');
        $btnThumbs.removeClass('active-view');
        $btnSimple.removeClass('active-view');
        $lotsWrap.addClass('product-list-price');
        $lotsWrap.removeClass('product-list-thumbs');
        $lotsWrap.removeClass('product-list-simple');

        $('.shop2-item-product .product-image').css('height', 'auto');
        $('.shop2-item-product').each(function() {
            var $prodImage = $(this).find('.product-image-wr');
            $(this).find('.product-info-top, .shop2-product-actions-wr').appendTo($prodImage);
        });
    }

    $btnThumbs.on(clickStart, function(e) {
        e.preventDefault();
        thumbsLots();

        eraseCookie('simple');
        eraseCookie('price');
        createCookie('thumbs', 1, 1);
        return false;
    });

    $btnSimple.on(clickStart, function(e) {
        e.preventDefault();
        simpleLots();

        eraseCookie('price');
        eraseCookie('thumbs');
        createCookie('simple', 1, 1);
        return false;
    });

    $btnPrice.on(clickStart, function(e) {
        e.preventDefault();
        priceLots();

        eraseCookie('simple');
        eraseCookie('thumbs');
        createCookie('price', 1, 1);
        return false;
    });
    function viewLots() {
        var $mainBlock = $lotsWrap.closest('.shop-main-block-wr').length;

            if (readCookie('thumbs') || $mainBlock == 1) {
                thumbsLots();
            } else if (readCookie('simple') && !$mainBlock == 1) {
                simpleLots();
            } else if (readCookie('price') && !$mainBlock == 1) {
                priceLots();
            }
    }
    $(window).on('resize', viewLots).trigger('resize');


    //---MainBlockHeight
    function mainBlockHeight() {

        $('.product-list-main').each(function() {
            var $this = $(this);

            var temp = 1;

            $this.find('.product-image img').bindImageLoad(function(){
                temp++;
                if(temp == $this.find('.product-image img').length) {
                    var heightsImg = [],
                        maxHeightImg,
                        heights = [],
                        maxHeight;
                        
                    $this.find('.product-image').css('height', 'auto');
                    $this.find('.product-price').css('marginTop', 0);

                    $this.find('.product-image').each(function(){
                        heightsImg.push($(this).height());
                    });
                    maxHeightImg = Math.max.apply(null, heightsImg);
                    
                    $this.find('.product-image').each(function(){                       
                        $(this).css('height', maxHeightImg);
                    });

                    $this.find('.shop2-item-product').each(function(){
                        heights.push($(this).height());
                    });
                    maxHeight = Math.max.apply(null, heights);
                    
                    $this.find('.shop2-item-product').each(function(){
                        var margTop = maxHeight - $(this).height();
                        
                        $(this).find('.product-price').css('marginTop', margTop);
                    });
                }
            });
        });
    }

    //---Collection-img-height
    if (shop2.mode=='product') {
        function collectionImgHeight() {

            var temp = 1;
            
            $('.shop-group-kinds-collection .product-image img').bindImageLoad(function(){
                temp++;
                if(temp == $('.shop-group-kinds-collection .product-image img').length) {
                    var heights = [],
                        maxHeight;
                        
                    $('.shop-group-kinds-collection .product-image').css('height', 'auto');

                    $('.shop-group-kinds-collection .product-image').each(function(){
                        heights.push($(this).height());
                    });
                    maxHeight = Math.max.apply(null, heights);
                    
                    $('.shop-group-kinds-collection .product-image').each(function(){                       
                        $(this).css('height', maxHeight);
                    });
                }
            });
        }
        function modificationImgHeight() {

            var temp = 1;
            
            $('.shop-group-kinds-in .product-image img').bindImageLoad(function(){
                temp++;
                if(temp == $('.shop-group-kinds-in .product-image img').length) {
                    var heights = [],
                        maxHeight;
                        
                    $('.shop-group-kinds-in .product-image').css('height', 'auto');

                    $('.shop-group-kinds-in .product-image').each(function(){
                        heights.push($(this).height());
                    });
                    maxHeight = Math.max.apply(null, heights);
                    
                    $('.shop-group-kinds-in .product-image').each(function(){                       
                        $(this).css('height', maxHeight);
                    });
                }
            });
        }
    }
    //Tabs
    if (shop2.mode == 'product') {

        var $tabs = $('#product_tabs');

        $tabs.responsiveTabs({
            rotate: false,
            startCollapsed: 'accordion',
            collapsible: 'accordion',
            animation: 'fadeIn',
            setHash: true,
            scrollToAccordion: true,
            scrollToAccordionOffset: 50,
            activate: function(){
                modificationImgHeight()
            }
        });

        (function() {

            // смена картинок
            var $thumbsProductPic = $('.product-thumbnails a'),
                $productPic = $('.product-l-side-wr .product-image a');
                $productPicLi = $('.product-thumbnails li');
                

            $thumbsProductPic.on(clickStart, function(e) {
                var ind = $thumbsProductPic.index(this);
                e.preventDefault();
                $productPic.hide().removeClass('active').eq(ind).show().addClass('active');
                $productPicLi.removeClass('active').eq(ind).addClass('active');
            });
        })();

        //---Prod-image
        var productImageFlag = 1,
            destroyFlag = 1;

        function productImageSlider() {
            if ($('.product-thumbnails').length) {
                if (window.matchMedia('(min-width:940px)').matches && (productImageFlag == 3 || productImageFlag == 1)) {

                    if (destroyFlag != 1) {
                        setTimeout(function() { 
                            slider.destroySlider();
                        }, 200);
                    }
                    
                    setTimeout(function() {
                        $('.product-thumbnails, .product-thumbnails li').removeAttr('style');
                        slider = $('.product-thumbnails').bxSlider({
                            mode: 'vertical',
                            auto: 0,
                            controls: 1,
                            pager: 0,
                            minSlides: 3,
                            adaptiveHeight: false,
                            maxSlides: 3,
                            slideWidth: 105,
                            slideMargin: 18,
                            infiniteLoop: 0,
                            useCSS: false,
                            preloadImages: 'all',
                            onSlideAfter: function(){
                                if(this.auto){
                                    slider.startAuto();
                                }
                            }
                        });
                    }, 400);
                    productImageFlag = 2;
                    destroyFlag = 2;
                } else if (window.matchMedia('(max-width:939px)').matches && (productImageFlag == 2 || productImageFlag == 1)){
                    
                    if (destroyFlag != 1) {
                        setTimeout(function() { 
                            slider.destroySlider();
                        }, 200);
                    }
                    
                    setTimeout(function() {
                        $('.product-thumbnails, .product-thumbnails li').removeAttr('style');
                        slider = $('.product-thumbnails').bxSlider({
                            mode: 'horizontal',
                            auto: 0,
                            controls: 1,
                            pager: 0,
                            minSlides: 3,
                            adaptiveHeight: false,
                            maxSlides: 3,
                            slideWidth: 84,
                            slideMargin: 14,
                            infiniteLoop: 0,
                            useCSS: false,
                            preloadImages: 'all',
                            onSlideAfter: function(){
                                if(this.auto){
                                    slider.startAuto();
                                }
                            }
                        });
                    }, 400);
                    productImageFlag = 3;
                    destroyFlag = 2;
                }
            }
        }

        //---Product-mobile
        var productMobileFlag = 1,
            prodBtnFixedFlag = 1;

        function productMobile() {
            if (window.matchMedia('(min-width:421px)').matches && productMobileFlag == 3){
                $('.shop2-product-mode-wr .product-shop2 .product-amount').appendTo('.add-form');
                $('.product-shop2 .product-btn').removeClass('fixed');

                $('.product-shop2 .add-form').css({
                    marginBottom: 10
                });

                productMobileFlag = 2;
            } else if (window.matchMedia('(max-width:420px)').matches){
                if (productMobileFlag == 2 || productMobileFlag == 1){
                    $('.shop2-product-mode-wr .product-shop2 .product-amount').prependTo('.product-btn');
                    productMobileFlag = 3;
                }
                
                var windowHeight = $(window).height(),
                    documentHeight = $(document).height(),
                    topHeight = $('.product-shop2 .product-btn').offset().top,
                    $prodBtnHeight = $('.product-shop2 .product-btn').outerHeight(true);

                $(document).scroll(function(e) {
                    if (window.matchMedia('(min-width:421px)').matches) return;


                    if ((documentHeight - windowHeight) <= topHeight) return;

                    if ($(document).scrollTop() >= topHeight && prodBtnFixedFlag == 1) {
                        $('.product-shop2 .product-btn').addClass('fixed');

                        $('.product-shop2 .add-form').css({
                            marginBottom: $prodBtnHeight
                        });

                        prodBtnFixedFlag = 2;
                    } else if($(document).scrollTop() < topHeight && prodBtnFixedFlag == 2) {
                        $('.product-shop2 .product-btn').removeClass('fixed');

                        $('.product-shop2 .add-form').css({
                            marginBottom: 0
                        });
                        
                        prodBtnFixedFlag = 1;
                    }
                });
            }
        }
    }

    //---Cart
    if (shop2.mode == 'cart') {
        $('.cart-product-info-view').on('click', function(event) {
            event.preventDefault();
            
            $(this).toggleClass('active').closest('.shop2-cart-product').find('.cart-product-info-wr').toggle();
        });
        $('.coupon-open-btn, .coupon-close-btn').on('click', function(event) {
            event.preventDefault();
            
            $('.shop2-coupon-wr').toggleClass('opened');
        });
    }

    //Buy-one-click
    
    (function(){
        if(!$('.buy-one-click-wr').length) return;
        
        var $form = $('.buy-one-click-form-wr'),
            $closeFormBtn = $('.buy-one-click-form-in .close-btn');
        
        $('.buy-one-click-wr > a').on(clickStart, function(e){
            e.preventDefault();
            var productLink = (shop2.mode!=="product") ? (document.location.origin)+$(this).closest('.shop2-item-product').find('.product-name > a').attr('href') : (document.location.href),
                productName = (shop2.mode!=="product") ? $(this).closest('.shop2-item-product').find('.product-name > a').html() + (' Количество:' + $(this).closest('.shop2-item-product').find('.shop2-product-amount input[type="text"]').val()) : $(this).closest('.site-container').find('h1').html() + (' Количество:' + $(this).closest('.product-r-side').find('.shop2-product-amount input[type="text"]').val());
            
            $form.addClass('active');
            setTimeout(function() {
                $form.find('input.productName').val(productName);
                $form.find('input.productLink').val(productLink);
            }, 800);
            
            if (isApple) {
                $('html, body').addClass('overflowHidden');
            } else {
                $(document.documentElement).addClass('overflowHidden');
            }
        });
        
        $closeFormBtn.on(clickStart, function(e){
            e.preventDefault();
            
            $form.removeClass('active');
            
            if (isApple) {
                $('html, body').removeClass('overflowHidden');
            } else {
                $(document.documentElement).removeClass('overflowHidden');
            }
        });
    })();
    
    
    //Top-panel
    function topPanel() {
	    var offsetTop = $(document).scrollTop();

	    $(document).scroll(function(e) {
			if ($('.menu-top-wr, .search-online-store').hasClass('opened')) return;
			if ($('.block-user').hasClass('active')) return;
			var topPanelHeight = $('.top-panel-wr.topPanelMobile').height();
			
			if ($(document).scrollTop() == 0 || $('.shop2-product-mode-wr .product-btn').hasClass('fixed')) {
		    	$('.top-panel-wr.topPanelMobile').removeClass('fixedPanel');
		    	$('.site-wrapper').css('paddingTop', 0);
		    	
		    	$('.top-panel-wr.topPanelMobile').css({
		    		'opacity' : '1',
		    		'visibility' : 'visible'
		    	});
			} else if ($(document).scrollTop() >= topPanelHeight) {
			    var offsetTopScroll = $(document).scrollTop();


			    if (offsetTopScroll > offsetTop) {
			    	$('.top-panel-wr.topPanelMobile').addClass('fixedPanel');
			    	$('.site-wrapper').css('paddingTop', topPanelHeight);
			    	
			    	$('.top-panel-wr.topPanelMobile').css({
			    		'opacity' : '0',
			    		'visibility' : 'hidden'
			    	});
			    } else {
			    	$('.top-panel-wr.topPanelMobile').css({
			    		'opacity' : '1',
			    		'visibility' : 'visible'
			    	});
			    }
			    offsetTop = offsetTopScroll;
			}
	    });
	    
    }
    topPanel();
    $('.shop-product-btn').on(clickStart, function(event) {
		
		    $('.top-panel-wr.topPanelMobile').css({
	    		'opacity' : '1',
	    		'visibility' : 'visible'
	    	});
		    
	});
    //---Styler

    $('input[type="radio"], input[type="checkbox"]').styler();
    
    $('.table-filter-param input[type=checkbox], .table-filter-param input[type=radio], .table-filter-param select, .search-online-store select, .product-options select, .products-per-page-wr select').styler({
        selectPlaceholder: 'Все'
    });
    $.ajaxSetup({
        complete: function(){
            $('.table-filter-param input[type=checkbox], .table-filter-param input[type=radio], .table-filter-param select, .search-online-store input[type=checkbox], .search-online-store input[type=radio], .search-online-store select, .product-options select').styler({selectPlaceholder: 'Все'})
        }
    });
    $('.product-compare input[type="checkbox"], .sg-page-article__comment-list input[type="checkbox"], .anketa-wrapper .input[type="radio"], .anketa-wrapper input[type="checkbox"]').styler('destroy');

    //---Resize
    function resizeFunction() {
        folderBlock();
        topMenu();
        viewBtnMobile();
        mainBlockHeight();
        if (shop2.mode == 'product') {
            productImageSlider();
            collectionImgHeight();
            modificationImgHeight();
        }
    }
    $(window).on('resize', resizeFunction).trigger('resize');

    if (shop2.mode == 'product') {
        $(window).load(function() {
            setTimeout(function() {
                $(window).on('resize', productMobile).trigger('resize');
            }, 500);
        });
    }
    $('.top-panel-in, .site-container, .site-header-in').css({
        opacity: 1
    });
    //---Document-click
    $(document).on(clickStart, function(event) {
        if ($(event.target).closest('#shop2-color-ext-popup, #shop2-color-ext-select, .classThis, .question, .search-block-wr, .search-block-btn, .folder-block-title, .folder-block-body, .brand-block-body, .brand-block-title, .menu-top-btn, .menu-top-body, .block-user-body-in, .block-user-title, .shop2-filter, .sorting-wrap, .buy-one-click-form-in, .buy-one-click-wr, #ui-datepicker-div, .ui-datepicker-header').length) return;

        $('.classThis').hide();
        $('div').removeClass('classThis');
        $('.block-user, .search-block-wr, .search-overlay-bg, .buy-one-click-form-wr').removeClass('active');
        $('.search-online-store, .folder-block-wr, .brand-block-wr, .menu-top-wr, .shop2-filter, .sorting-wrap').removeClass('opened')

        if (isApple) {
            $('html, body').removeClass('overflowHidden');
        } else{
            $(document.documentElement).removeClass('overflowHidden');
        }
    });

     $(this).keydown(function(eventObject){
        if (eventObject.which == 27){
            $('.block-user-body, .buy-one-click-form-wr').removeClass('active');
        
        if (/iPod|iPad|iPhone/i.test(navigator.userAgent)) {
                $('html, body').removeClass('overflowHidden');
            } else {
                $(document.documentElement).removeClass('overflowHidden');
            }
        }
    });
     
    //Float
    var inputRangeMax = parseInt($('.search-online-store input.small.hight').data('max'));
    
    $('.input_range_slider').each(function(index, el) {

        var $this = $(this),
            $lower = $this.closest('.range_slider_wrapper').find('.low'),
            $upper = $this.closest('.range_slider_wrapper').find('.hight'),
            arr = [0,inputRangeMax];
            
        var slider = $this.noUiSlider({
                        start: [$lower.attr('value'), $upper.attr('value')],
                        connect: true,
                        behaviour: 'drag-tap',
                        format: wNumb({
                            decimals: 0
                        }),
                        range: {
                            'min': [ arr[0] ],
                            'max': [ arr[1] ]
                        }
                    });

        slider.Link('lower').to($lower);
        slider.Link('upper').to($upper);
    });
    //---PhotoSwipe
    $('.product-l-side-wr').lightGallery({
        selector: '.product-image a',
        thumbnail: false,
        download: false
    });
});